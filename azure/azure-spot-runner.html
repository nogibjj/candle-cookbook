<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Azure spot runner setup - Candle Cookbook</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../home.html"><strong aria-hidden="true">1.</strong> Candle Cookbook</a></li><li class="chapter-item expanded "><a href="../local/index.html"><strong aria-hidden="true">2.</strong> Local Builds</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../local/hello-candle.html"><strong aria-hidden="true">2.1.</strong> Hello, Candle!</a></li></ol></li><li class="chapter-item expanded "><a href="../aws/index.html"><strong aria-hidden="true">3.</strong> AWS Builds</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../aws/hello-aws.html"><strong aria-hidden="true">3.1.</strong> Hello, Candle on AWS!</a></li><li class="chapter-item expanded "><a href="../aws/jenkins-pipeline.html"><strong aria-hidden="true">3.2.</strong> CodePipeline + Jenkins Build</a></li></ol></li><li class="chapter-item expanded "><a href="../azure/index.html"><strong aria-hidden="true">4.</strong> Azure Builds</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../azure/hello-azure.html"><strong aria-hidden="true">4.1.</strong> Hello, Candle on Azure!</a></li><li class="chapter-item expanded "><a href="../azure/azure-spot-runner.html" class="active"><strong aria-hidden="true">4.2.</strong> Azure spot runner setup</a></li><li class="chapter-item expanded "><a href="../azure/candle-VM.html"><strong aria-hidden="true">4.3.</strong> Azure VM + Github Action</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Candle Cookbook</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="azure-spot-runner-with-github-action"><a class="header" href="#azure-spot-runner-with-github-action">Azure spot runner with Github Action.</a></h1>
<p>Using Ephemeral Infrastructure with Azure VMS as GitHub Action Runners to build Candle binary latter.</p>
<h2 id="requirements"><a class="header" href="#requirements">Requirements</a></h2>
<ul>
<li>
<p>Setup <a href="../hello-azure.html">Azure Account</a> and record the <code>subscription ID</code> you have from the setting. </p>
</li>
<li>
<p>Create a <a href="https://github.com/settings/tokens/new?description=Azure+GitHub+Runner&amp;scopes=repo">Personal Access Token (PAT)</a> record as <code>$GitHubPAT</code></p>
</li>
</ul>
<h3 id="create-an-service-principle-with-the-following-details"><a class="header" href="#create-an-service-principle-with-the-following-details">Create an service principle with the following details:</a></h3>
<ul>
<li>AppID </li>
<li>password </li>
<li>tenant information </li>
</ul>
<h4 id="create-an-service-principal-by-running"><a class="header" href="#create-an-service-principal-by-running">Create an service principal by running:</a></h4>
<pre><code>$ az ad sp create-for-rbac -n &quot;Name_of_Service_principal&quot;
</code></pre>
<ul>
<li>This output contains all the infomation about your <code>AZURE_CREDENTIALS</code>. Please copy &amp; save it to your local in order to set up VM after we setup the Spot Runner.</li>
</ul>
<p>The output includes credentials that you must protect. Be sure that you do not include these credentials in your code or check the credentials into your source control. For more information, see https://aka.ms/azadsp-cli</p>
<h3 id="create-an-azure-resource-group"><a class="header" href="#create-an-azure-resource-group">Create an Azure Resource Group</a></h3>
<p>A resource group is a way to group services together so that you can keep track of them and delete them later with ease. Use the <code>az</code> CLI to accomplish this:</p>
<pre><code>az group create --location eastus --name &quot;&lt;RESOURCE_GROUP_NAME&gt;&quot;
</code></pre>
<p>Keep that resource group name handy for other operations. In this repository the <code>$&lt;RESOURCE_GROUP_NAME&gt;</code> resource group is used throughout. Note the location as well. Make sure that the location (region) maps to the resources you want to create.</p>
<h3 id="create-an-azure-key-vault"><a class="header" href="#create-an-azure-key-vault">Create an Azure Key Vault</a></h3>
<p>You will store your GitHub PAT here so that it can later be retrieved by the VM.</p>
<pre><code>$ az keyvault create --name candel-vms --resource-group githubVM --location eastus
$ az keyvault secret set --vault-name candel-vms --name &quot;GitHubPAT&quot; --value $GITHUB_PAT
</code></pre>
<p>Replace $GITHUB_PAT with the value of the PAT created earlier</p>
<h3 id="assign-an-identity-with-permissions-for-key-vault"><a class="header" href="#assign-an-identity-with-permissions-for-key-vault">Assign an identity with permissions for Key Vault</a></h3>
<p>Now that the key vault is created, you need to create an identity and then allow resources in the resource group to be able to access it. You must give this identity a name, in this case we use GitHubVMs. Note this name will be used in other steps.</p>
<pre><code>$ az identity create --name GitHubVMs --resource-group githubVM --location eastus

</code></pre>
<p>Capture the Principal ID which will be used for the value for --object-id later. You can retrieve it again by using:</p>
<pre><code>$ az identity show --name GitHubVMs --resource-group githubVM
</code></pre>
<p>Use the object id to set the policy, replace $OBJECT_ID with the one you found in the previous command:</p>
<pre><code>$ az keyvault set-policy --name candel-vms --object-id &lt;$BOJECT_ID&gt; --secret-permissions get
</code></pre>
<h3 id="verify-you-can-get-the-pat-with-the-following-command"><a class="header" href="#verify-you-can-get-the-pat-with-the-following-command">Verify you can get the PAT with the following command:</a></h3>
<pre><code>az keyvault secret show --name &quot;GitHubPAT&quot; --vault-name candel-vms --query value -o tsv
</code></pre>
<h3 id="provide-a-role-to-vms"><a class="header" href="#provide-a-role-to-vms">Provide a role to VMs</a></h3>
<p>Assign a role to the VMs so that they have enough permissions to write the image when getting created. Start by finding the principalId which will then be needed for the next step:</p>
<pre><code>az identity show --name GitHubVMs --resource-group githubVM --query principalId
</code></pre>
<p>With the principalId you can assign it to the VMs now:</p>
<pre><code>az role assignment create --assignee &lt;principal_ID&gt; --role Contributor --resource-group githubVM
</code></pre>
<h3 id="trigger-the-create-image-run"><a class="header" href="#trigger-the-create-image-run">Trigger the create image run</a></h3>
<p>Now you are ready to create the image. Run it manually and make sure it works correctly. If succesful, an image will be created for you which you can query with the following command:</p>
<pre><code>az image list --resource-group githubVM --output table
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../azure/hello-azure.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../azure/candle-VM.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../azure/hello-azure.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../azure/candle-VM.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
